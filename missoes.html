<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SwiftPro – Gamificação para Lojas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script defer src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="assets/css/style.css" />

    <!-- Sistema de Autenticação -->
    <script src="assets/js/auth.js"></script>
    <script>
      // Proteger página - qualquer usuário logado pode acessar
      window.checkPageAccess();
    </script>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg sticky-top"
      aria-label="Navegação principal"
    >
      <div class="container">
        <a
          class="navbar-brand d-flex align-items-center gap-2"
          href="index.html"
        >
          <i class="bi bi-fire text-brand"></i>
          <strong>SwiftPro</strong>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#navOffcanvas"
          aria-controls="navOffcanvas"
          aria-label="Abrir menu"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="offcanvas offcanvas-end" tabindex="-1" id="navOffcanvas">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menu</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="offcanvas"
              aria-label="Fechar"
            ></button>
          </div>
          <div class="offcanvas-body">
            <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-3">
              <li class="nav-item">
                <a class="nav-link" href="ranking.html">Ranking</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="missoes.html">Missões</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="plano.html">Trilha de Aprendizagem</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="gerente.html">Área do Gerente</a>
              </li>
              <li class="nav-item"></li>
              <li class="nav-item"></li>
            </ul>
            <div class="d-flex gap-2 ms-lg-3 mt-3 mt-lg-0 align-items-center">
              <!-- Menu dropdown do usuário -->
              <div class="dropdown text-end">
                <a
                  href="#"
                  class="d-flex align-items-center text-decoration-none dropdown-toggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <img
                    src="https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=400&auto=format&fit=crop"
                    alt="Avatar do usuário"
                    width="32"
                    height="32"
                    class="rounded-circle me-2"
                    data-user-avatar
                  />
                  <span class="d-none d-lg-inline-block" data-user-name
                    >Usuário</span
                  >
                </a>
                <ul class="dropdown-menu text-small">
                  <li class="dropdown-header">
                    <div class="fw-semibold" data-user-name>Usuário</div>
                    <small class="text-muted" data-user-email
                      >usuario@swift.com</small
                    >
                    <small class="text-muted d-block" data-user-role
                      >Carregando...</small
                    >
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a class="dropdown-item" href="config.html"
                      ><i class="bi bi-gear me-2"></i>Configurações</a
                    >
                  </li>
                  <li>
                    <a class="dropdown-item" href="historico.html"
                      ><i class="bi bi-clock-history me-2"></i>Histórico</a
                    >
                  </li>
                  <li data-manager-only>
                    <a class="dropdown-item" href="gerente.html"
                      ><i class="bi bi-person-gear me-2"></i>Área do Gerente</a
                    >
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a class="dropdown-item" href="#" data-logout
                      ><i class="bi bi-box-arrow-right me-2"></i>Sair</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <section id="missoes" class="py-5">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h2 class="h4 m-0">Missões</h2>
          <div class="d-flex gap-2">
            <select
              id="filter-type"
              class="form-select form-select-sm"
              aria-label="Filtrar tipo"
            >
              <option value="">Todos os tipos</option>
              <option value="vendas">Vendas</option>
              <option value="cross-sell">Cross-sell</option>
              <option value="produtos">Produtos</option>
              <option value="atendimento">Atendimento</option>
              <option value="metas">Metas</option>
            </select>
            <select
              id="filter-period"
              class="form-select form-select-sm"
              aria-label="Filtrar período"
            >
              <option value="">Todos os períodos</option>
              <option value="daily">Diárias</option>
              <option value="weekly">Semanais</option>
              <option value="monthly">Mensais</option>
            </select>
          </div>
        </div>

        <!-- Loading state -->
        <div id="missions-loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando missões...</span>
          </div>
          <p class="mt-2 text-muted">Carregando suas missões...</p>
        </div>

        <!-- Error state -->
        <div id="missions-error" class="alert alert-danger d-none" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Erro ao carregar missões</strong>
          <p class="mb-0">
            Não foi possível carregar suas missões. Tente recarregar a página.
          </p>
        </div>

        <!-- Empty state -->
        <div id="missions-empty" class="text-center py-5 d-none">
          <i class="bi bi-list-task text-muted" style="font-size: 3rem"></i>
          <h3 class="h5 mt-3 text-muted">Nenhuma missão encontrada</h3>
          <p class="text-muted">
            Não há missões disponíveis para você no momento.
          </p>
        </div>

        <!-- Missions container -->
        <div id="missions-container" class="row g-3 d-none"></div>
      </div>
    </section>
    <footer class="py-4 mt-4">
      <div
        class="container d-flex flex-column flex-md-row align-items-center justify-content-between gap-2"
      >
        <div class="text-muted small">
          © 2025 SwiftPro. Todos os direitos reservados.
        </div>
        <div class="d-flex align-items-center gap-3">
          <a class="small text-decoration-none" href="#">Termos</a>
          <a class="small text-decoration-none" href="#">Privacidade</a>
          <a class="small text-decoration-none" href="#">Ajuda</a>
        </div>
      </div>
    </footer>

    <!-- Sistema de Banco de Dados -->
    <script src="assets/js/database.js"></script>
    <!-- Sistema de Autenticação -->
    <script src="assets/js/auth.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- JavaScript para carregar missões -->
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const loadingEl = document.getElementById("missions-loading");
        const errorEl = document.getElementById("missions-error");
        const emptyEl = document.getElementById("missions-empty");
        const containerEl = document.getElementById("missions-container");
        const filterTypeEl = document.getElementById("filter-type");
        const filterPeriodEl = document.getElementById("filter-period");

        let currentUserMissions = [];
        let currentUser = null;

        // Inicializar página
        await initializePage();

        // Event listeners para filtros
        filterTypeEl.addEventListener("change", renderMissions);
        filterPeriodEl.addEventListener("change", renderMissions);

        async function initializePage() {
          try {
            // Obter usuário atual
            currentUser = window.SwiftAuth.getCurrentUser();
            if (!currentUser) {
              throw new Error("Usuário não encontrado");
            }

            // Carregar missões do usuário
            currentUserMissions = await window.SwiftDB.getUserMissions(
              currentUser.id
            );
            console.log("Missões carregadas:", currentUserMissions);

            // Renderizar missões
            renderMissions();
          } catch (error) {
            console.error("Erro ao carregar missões:", error);
            showError(
              "Erro ao carregar suas missões. Tente recarregar a página."
            );
          }
        }

        function renderMissions() {
          try {
            hideAllStates();

            // Aplicar filtros
            let filteredMissions = currentUserMissions;

            const typeFilter = filterTypeEl.value;
            const periodFilter = filterPeriodEl.value;

            if (typeFilter) {
              filteredMissions = filteredMissions.filter(
                (mission) => mission.category === typeFilter
              );
            }

            if (periodFilter) {
              filteredMissions = filteredMissions.filter(
                (mission) => mission.type === periodFilter
              );
            }

            if (filteredMissions.length === 0) {
              showEmpty();
              return;
            }

            // Renderizar missões
            containerEl.innerHTML = "";
            filteredMissions.forEach((mission) => {
              const missionCard = createMissionCard(mission);
              containerEl.appendChild(missionCard);
            });

            showContainer();
          } catch (error) {
            console.error("Erro ao renderizar missões:", error);
            showError("Erro ao exibir missões.");
          }
        }

        function createMissionCard(mission) {
          const col = document.createElement("div");
          col.className = "col-12 col-lg-4";

          const progress = mission.user_progress || {};
          const progressPercent = calculateProgress(mission, progress);
          const statusBadge = getStatusBadge(mission.type);
          const statusColor = getStatusColor(progress.status);

          col.innerHTML = `
            <div class="card h-100 ${statusColor.border}">
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <strong>${mission.title}</strong>
                    ${statusBadge}
                  </div>
                  <span class="badge bg-warning-subtle text-dark">+${
                    mission.points_reward
                  } pts</span>
                </div>
                <div class="small text-muted mb-2">
                  ${mission.description}
                </div>
                <div class="progress mb-2" style="height: 5px;">
                  <div class="progress-bar ${
                    statusColor.progress
                  }" style="width: ${progressPercent}%"></div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted">${getProgressText(
                    mission,
                    progress
                  )}</small>
                  <small class="text-muted">${getTimeRemaining(mission)}</small>
                </div>
                <div class="mt-auto d-flex gap-2">
                  <button class="btn btn-sm btn-outline-secondary" onclick="showMissionDetails(${
                    mission.id
                  })">
                    Detalhes
                  </button>
                  ${
                    progress.status === "completed"
                      ? '<span class="badge bg-success-subtle text-success">Concluída</span>'
                      : ""
                  }
                </div>
              </div>
            </div>
          `;

          return col;
        }

        function calculateProgress(mission, progress) {
          if (progress.status === "completed") return 100;

          if (progress.progress) {
            if (
              progress.progress.sales_count &&
              mission.requirements.sales_count
            ) {
              return Math.min(
                100,
                (progress.progress.sales_count /
                  mission.requirements.sales_count) *
                  100
              );
            }
            if (
              progress.progress.cross_sell_count &&
              mission.requirements.cross_sell_count
            ) {
              return Math.min(
                100,
                (progress.progress.cross_sell_count /
                  mission.requirements.cross_sell_count) *
                  100
              );
            }
            if (
              progress.progress.positive_reviews &&
              mission.requirements.positive_reviews
            ) {
              return Math.min(
                100,
                (progress.progress.positive_reviews /
                  mission.requirements.positive_reviews) *
                  100
              );
            }
          }

          return 0;
        }

        function getProgressText(mission, progress) {
          if (progress.status === "completed") return "Concluída";

          if (progress.progress) {
            if (
              progress.progress.sales_count &&
              mission.requirements.sales_count
            ) {
              return `${progress.progress.sales_count} de ${mission.requirements.sales_count}`;
            }
            if (
              progress.progress.cross_sell_count &&
              mission.requirements.cross_sell_count
            ) {
              return `${progress.progress.cross_sell_count} de ${mission.requirements.cross_sell_count}`;
            }
            if (
              progress.progress.positive_reviews &&
              mission.requirements.positive_reviews
            ) {
              return `${progress.progress.positive_reviews} de ${mission.requirements.positive_reviews}`;
            }
          }

          return "Não iniciada";
        }

        function getStatusBadge(type) {
          const badges = {
            daily:
              '<span class="badge bg-danger-subtle text-danger ms-2">Diária</span>',
            weekly:
              '<span class="badge bg-primary-subtle text-primary ms-2">Semanal</span>',
            monthly:
              '<span class="badge bg-success-subtle text-success ms-2">Mensal</span>',
          };
          return (
            badges[type] ||
            '<span class="badge bg-secondary-subtle text-secondary ms-2">Padrão</span>'
          );
        }

        function getStatusColor(status) {
          switch (status) {
            case "completed":
              return { border: "border-success", progress: "bg-success" };
            case "in_progress":
              return { border: "", progress: "bg-primary" };
            default:
              return { border: "", progress: "bg-secondary" };
          }
        }

        function getTimeRemaining(mission) {
          if (!mission.expires_at) return "";

          const now = new Date();
          const expires = new Date(mission.expires_at);
          const diffTime = expires - now;

          if (diffTime <= 0) return "Expirada";

          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          if (diffDays === 1) return "Expira hoje";
          if (diffDays < 7) return `${diffDays} dias restantes`;

          const diffWeeks = Math.ceil(diffDays / 7);
          return `${diffWeeks} semana${diffWeeks > 1 ? "s" : ""} restantes`;
        }

        function hideAllStates() {
          loadingEl.classList.add("d-none");
          errorEl.classList.add("d-none");
          emptyEl.classList.add("d-none");
          containerEl.classList.add("d-none");
        }

        function showContainer() {
          hideAllStates();
          containerEl.classList.remove("d-none");
        }

        function showEmpty() {
          hideAllStates();
          emptyEl.classList.remove("d-none");
        }

        function showError(message) {
          hideAllStates();
          errorEl.querySelector("p").textContent = message;
          errorEl.classList.remove("d-none");
        }

        // Função global para detalhes da missão
        window.showMissionDetails = function (missionId) {
          const mission = currentUserMissions.find((m) => m.id === missionId);
          if (mission) {
            alert(
              `Detalhes da Missão: ${mission.title}\n\n${mission.description}\n\nRecompensa: ${mission.points_reward} pontos`
            );
          }
        };
      });
    </script>
  </body>
</html>
